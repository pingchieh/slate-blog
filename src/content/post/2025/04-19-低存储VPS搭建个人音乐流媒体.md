---
title: 利用Navidrome搭建个人音乐流媒体
description: 本文将介绍一种巧妙的解决方案：结合 Navidrome 的元数据管理能力、Cloudflare Workers 的边缘计算能力以及您已有的云存储（如 Cloudflare R2、AWS S3，或通过 Alist 挂载的各种网盘），即使在存储空间极其有限的 VPS 或容器服务上，也能搭建功能完善、响应迅速的个人音乐流媒体服务。
tags: [Navidrome, Cloudflare, 音乐流媒体]
pubDate: 2025-04-19
draft: false
---

之前趁着QQ音乐会员到期前，下了不少歌，于是想搭个个人音乐库，这样也能省下一笔会员费。毕竟音乐这种东西我也不是天天听，开会员有点浪费，但是折腾来折腾去总是找不到完美方案。

首先是个人电脑不能24小时开机满足不了多平台访问，总不能晚上想听个歌助眠还要爬起来开电脑吧，大盘鸡VPS又是一笔额外支出，还不如直接开会员呢。

emby和jellyfin虽然支持strm但是配置要求又很高，我还想直接使用白嫖的免费容器呢。

然后是alist挂载网盘使用webdav提供服务，可是找来找去支持webdav的音乐播放器要不就是收费，要不然就体验很烂。

最后是navidrome不支持远程存储，我也试过用rclone挂载到本地给navidrome使用，但是很卡很卡，几乎不可用。

最后实在没办法了，尝试分析了一下navidrome的请求，发现可以通过劫持其流服务来将请求转发到网盘服务上，这样只需要免费的容器服务就可以实现个人音乐流媒体服务。

## **核心思路：**

利用本地计算机生成 Navidrome 的音乐元数据数据库，然后将此数据库部署到容器上的 Navidrome 实例（该实例不扫描实际文件）。接着，通过 Cloudflare Workers 拦截 Navidrome 的音乐文件请求，查询 Cloudflare D1 数据库（预先存储了文件 ID 和云端路径的映射关系），最终将请求重定向到实际存储音乐文件的云端地址。

## 前提条件

1. **音乐文件：** 本地计算机存有一份完整的音乐库，同时在云存储（如 Cloudflare R2, AWS S3, Google Cloud Storage, 或通过 Alist 暴露的网盘等）也有一份完全一致的副本。
2. **本地环境：** 一台可以运行 Navidrome 并访问完整音乐库的本地计算机，用于初次扫描。
3. **服务器环境：** 一台 VPS 或其他可以运行 Navidrome 的容器服务（存储空间可以很小）。
4. **Cloudflare 账户：** 用于 DNS 解析、Workers 和 D1 数据库服务。
5. **云存储访问：** 确保你的云存储可以被公开或半公开访问（例如，通过签名 URL 或公开存储桶），以便 Worker 重定向后能够访问。

## 工具

* Navidrome 程序
* SQLite 编辑工具（如 DB Browser for SQLite, DBeaver, 或文中提到的 `sqlitestudio`）
* Cloudflare `wrangler` CLI 工具 (通过 `npm install -g wrangler` 安装)

## 第一步：本地扫描与数据库准备

1. **本地运行 Navidrome：** 在你的本地计算机上配置并运行 Navidrome，确保 `MusicFolder` 指向你完整的本地音乐库路径。让 Navidrome 完成一次彻底的扫描。
2. **获取数据库文件：** 扫描完成后，在 Navidrome 的数据目录（通常由 `DataFolder` 配置项指定）中找到 `navidrome.db` 文件。这个文件包含了所有音乐的元数据、播放列表信息以及文件路径（相对于本地扫描目录）。
3. **上传数据库：** 将这个 `navidrome.db` 文件上传到远程设备，放置在计划运行 Navidrome (VPS 版) 的数据目录中。

## 第二步：远程部署 Navidrome (仅元数据模式)

现在，我们在存储有限的容器上运行 Navidrome，但配置它不主动扫描文件，只使用我们上传的数据库。
创建或修改 Navidrome 的配置文件 (`navidrome.toml`)，确保以下设置生效，以禁用扫描相关功能：

```toml
# 指定数据目录，确保 navidrome.db 文件在此目录下
DataFolder = "/path/to/your/navidrome/data" 
# MusicFolder 理论上可以随意指定一个空目录，因为扫描已禁用
MusicFolder = "/path/to/dummy/music/folder" 

# 禁用内置的指标收集（可选）
EnableInsightsCollector = false 
# 设置默认语言（可选）
DefaultLanguage = 'zh-Hans' 

# --- 关键配置：禁用扫描 ---
# 完全禁用扫描器
Scanner.Enabled = false 
# 禁用文件监控等待（无需监控本地文件变化）
Scanner.WatcherWait = 0 
# 禁用启动时扫描
Scanner.ScanOnStartup = false 
```

使用`navidrome -c navidrome.toml`启动服务。

## 第三步：使用 Cloudflare 代理

很简单，不再详述。

## 第四步：创建文件 ID 到云端路径的映射数据库 (Cloudflare D1)

这一步是整个方案的核心：建立 Navidrome 内部文件 ID 与云存储中实际文件路径的对应关系。

1. **复制并编辑数据库：** 在你的本地计算机上，复制一份 `navidrome.db` 文件（避免直接修改原始文件）。使用 SQLite 编辑工具打开这份副本。
2. **提取关键数据：** 找到 `media_file` 表。删除除 `id` 和 `path` 之外的所有列。
3. **导出为 SQL：** 将修改后的 `media_file` 表导出为 SQL 文件，例如 `media_file.sql`。选择只导出数据 (INSERT 语句)。
4. **清理 SQL 文件：** 打开 `media_file.sql` 文件，删除文件开头可能存在的 `BEGIN TRANSACTION;` 或类似语句，以及文件末尾的 `COMMIT TRANSACTION;` 。
5. **创建 D1 数据库：** 使用 `wrangler` 或 Cloudflare 控制台创建一个 D1 数据库，例如命名为 `navidrome-db`。
6. **导入数据到 D1：** 使用 `wrangler` 将 SQL 文件中的数据导入 D1 数据库。执行以下命令（确保已登录 `wrangler`）：

```bash
npx wrangler d1 execute navidrome-db --remote --file=media_file.sql 
```

## 第五步：创建 Cloudflare Worker 拦截并重定向音乐流

创建一个 Worker 脚本，它将拦截发往 Navidrome `/rest/stream` 端点的请求，并根据 D1 数据库中的映射关系重定向到云存储。

1. **创建 Worker：** 使用 `wrangler` 或 Cloudflare 控制台创建一个新的 Worker 服务。
2. **绑定 D1 数据库：** 在 Worker 的设置中，添加 D1 数据库绑定。将上一步创建的 D1 数据库 (`navidrome-db`) 绑定到 Worker，并设置绑定名称为 `DB`（代码中将通过 `env.DB` 访问）。
3. **编写 Worker 代码：** 编辑 Worker 的 `index.js` (或 `src/index.js`) 文件，粘贴以下代码：

    ```javascript
    // !! 重要安全提示 !!
    // 以下代码未处理身份验证。这意味着任何知道您 Navidrome 域名的人
    // 理论上都可以通过构造 /rest/stream?id=... 请求来尝试访问您的音乐文件。
    // 在生产环境中，强烈建议您采取措施保护此 Worker：
    // 1. Cloudflare Access：在 Worker 路由前添加访问策略。
    // 2. Token 验证：修改 Navidrome 客户端（如果可能）或通过更复杂的 Worker
    //    逻辑来验证 Navidrome 的会话/令牌，但这非常复杂。
    // 3. 签名 URL：如果您的云存储支持，可以在 Worker 中生成临时的、
    //    有时间限制的签名 URL 来访问文件，而不是直接暴露永久链接。
    //
    // 此处提供的代码为基础实现，请务必根据您的安全需求进行增强。
    const BASE_URL = "https://your-cloud-storage-base-url/"; 

    export default {
      async fetch(request, env, ctx) {
        const url = new URL(request.url);
        const { pathname } = url;

        if (pathname === "/rest/stream") {
          // 获取 Navidrome 传递的文件 ID
          const file_id = url.searchParams.get("id");
          if (!file_id) {
            return new Response("Missing 'id' parameter", { status: 400 });
          }

          try {
            const stmt = env.DB.prepare("SELECT path FROM media_file WHERE id = ?");
            const { results } = await stmt.bind(file_id).all();

            if (!results || results.length === 0) {
              console.error(`File ID not found in D1: ${file_id}`);
              return new Response("File mapping not found in D1", { status: 404 });
            }
            const filePath = results[0].path;
            const encodedFilePath = encodeURIComponent(filePath).replace(/%2F/g, "/"); // 编码但保留斜杠

            // 构建完整的云存储文件 URL
            // 注意：确保 BASE_URL 结尾有斜杠，或者根据需要调整拼接逻辑
            const fileURL = BASE_URL + encodedFilePath;
            return Response.redirect(fileURL, 302); 

          } catch (error) {
            console.error(`Error processing stream request for ID ${file_id}: ${error}`);
            return new Response("Internal server error", { status: 500 });
          }
        }
        return new Response("Request not handled by this worker path");
      },
    };
    ```

4. **配置 Worker 路由：** 在 Cloudflare 控制台为你的 Worker 添加一个路由。
    * **路由模式：** `your.navidrome.domain.com/rest/stream*`

## 第六步：处理专辑封面等静态资源 (TODO)

当前的 Worker 只处理了音乐文件 (`/rest/stream`) 的重定向。Navidrome 客户端（Web UI 或 App）还会请求专辑封面 (`/rest/getCoverArt`)、艺术家图片 (`/rest/getAvatar`) 等。

这个步骤相对复杂，可以作为后续优化的方向。

## 总结

通过以上步骤，你就成功搭建了一个“混合模式”的 Navidrome 服务：元数据和 Web 服务运行在低存储的 VPS 上，而实际的音乐文件流则由 Cloudflare Workers 智能地重定向到你的大容量云存储。这既解决了 VPS 存储不足的问题，又让你能随时随地享受自己的音乐收藏。

记得定期（例如添加新音乐后）重复第一步（本地扫描）和第四步（更新 D1 数据库），以保持音乐库的同步。
