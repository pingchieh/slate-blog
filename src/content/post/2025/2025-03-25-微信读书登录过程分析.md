---
title: 微信读书登录过程分析
description: 本文通过使用 charles 抓包工具和 jadx-gui 对微信读书的 apk 进行反编译，详细分析了微信读书的登录过程，包括获取时间戳和签名、获取登录二维码、监控扫码状态、获取登录凭证以及刷新登录凭证等步骤。
tags: [微信读书, 抓包分析, 反编译]
pubDate: 2025-03-25
draft: false
---

通过使用 charles 抓包工具，对微信读书登录过程进行抓包，同时辅助使用 jadx-gui 对微信读书的 apk 进行反编译，分析微信读书登录过程。全过程记录如下。

本文使用的微信读书版本为墨水屏版1.9.3.10244349。

## 1. 获取时间戳和签名

通过抓包可以得到如下请求：

```bash
curl -H "baseapi: 34" \ 
     -H "appver: 1.9.3.10244349" \
     -H "osver: 14" \
     -H "channelid: 990" \
     -H "basever: 1.9.3.10244349" \
     -H "user-agent: WeRead/1.9.3 WRBrand/null wr_eink Dalvik/2.1.0 (Linux; U; Android 14; Redmi Note 7 Build/AP2A.240905.003)" \
     "https://i.weread.qq.com/wxticket?nonceStr=weread"
```

其中参数说明：

- `baseapi`：安卓系统接口版本号，例如安卓14的api版本为34
- `appver`：微信读书版本号
- `osver`：Android 版本号
- `channelid`：渠道号，墨水屏版本为990

返回结果格式如下：

```json
{
    "signature": "",
    "timeStamp": 1737110000,
    "expires_in": 3611
}
```

## 2. 获取登录二维码

通过上一步请求结果的`signature`和`timeStamp`，可以得到登录二维码的请求：

```bash
curl -H "User-Agent: Dalvik/2.1.0 (Linux; U; Android 14; Redmi Note 7 Build/AP2A.240905.003)" \ 
     "https://open.weixin.qq.com/connect/sdk/qrconnect?appid=wxab9b71ad2b90ff34&noncestr=weread&timestamp=1737110000&scope=snsapi_userinfo,snsapi_friend,snsapi_favorites&signature=$signature$"
```

返回结果格式如下：

```json
{
    "errcode": 0,
    "uuid": "",
    "appname": "微信读书",
    "qrcode": 
    {
        "qrcodebase64": "",
        "qrcodelength": 62060
    }
}
```

## 3. 监控扫码状态

通过对上一步返回数据中的`qrcodebase64`进行 base64 解码，得到二维码图片，再扫码登录之前，需要通过上一步得到的`uuid`构建请求，对扫码状态进行监控：

```bash
curl -H "User-Agent: Dalvik/2.1.0 (Linux; U; Android 14; Redmi Note 7 Build/AP2A.240905.003)" \ 
 "https://long.open.weixin.qq.com/connect/l/qrconnect?f=json&uuid=$uuid$"
```

如果一段时间后还未扫码，则返回：

```json
{
    "wx_errcode": 408,
    "wx_code": ""
}
```

此时需要持续对其进行请求：

```bash
curl -H "User-Agent: Dalvik/2.1.0 (Linux; U; Android 14; Redmi Note 7 Build/AP2A.240905.003)" \ 
 "https://long.open.weixin.qq.com/connect/l/qrconnect?f=json&uuid=$uuid$&last=408"
```

直到二维码失效或扫码完成：

```json
{
    "wx_errcode": 405,
    "wx_code": ""
}
```

## 4. 获取登录凭证

登录请求为：

```bash
curl -H "baseapi: 34"\
     -H "appver: 1.9.3.10244349"\
     -H "osver: 14"\
     -H "channelid: 990"\
     -H "basever: 1.9.3.10244349"\
     -H "user-agent: WeRead/1.9.3 WRBrand/null wr_eink Dalvik/2.1.0 (Linux; U; Android 14; Redmi Note 7 Build/AP2A.240905.003)"\
     -H "content-type: application/json; charset=UTF-8" \
      --data-binary "{\"code\":\"\",\"deviceId\":\"\",\"deviceName\":\"Redmi Note 7\",\"deviceType\":3,\"isAutoLogout\":0,\"isFromQrcode\":1,\"random\":35,\"signature\":\"\",\"timestamp\":1737113341847,\"trackId\":\"\"}"\
    "https://i.weread.qq.com/login"
```

请求体：

```json
{
    "code": "",
    "deviceId": "",
    "deviceName": "Redmi Note 7",
    "deviceType": 3,
    "isAutoLogout": 0,
    "isFromQrcode": 1,
    "random": 35,
    "signature": "",
    "timestamp": 1737113341847,
    "trackId": ""
}
```

参数说明：

- `code`：上一步得到的`wx_code`
- `deviceId`：设备 ID，墨水屏固定为`eink33+26位随机数`
- `deviceName`：设备名称，可随意填写。`微信阅读器`、`微信阅读器(第二代)`、`墨水屏`
- `deviceType`：设备类型，3 表示墨水屏
- `isAutoLogout`：是否自动退出，0 表示否
- `isFromQrcode`：是否扫码登录，1 表示是
- `random`：随机数，0-1000之间
- `timestamp`：当前时间戳
- `signature`：签名，通过`deviceId`、`random`和`timestamp`计算得到

`signature`计算方法，使用C#实现：

```csharp

/// <summary>
/// 设备ID（eink33+26位随机数）
/// 时间戳
/// 0-999随机数
/// </summary>
public static string GetAntiReplaySignature(string deviceId, long timestamp, int number)
{
    if (string.IsNullOrEmpty(deviceId))
    {
        throw new ArgumentException("Token cannot be null or empty", nameof(deviceId));
    }
    try
    {
        using SHA256 sha256 = SHA256.Create();
        sha256.Initialize();
        string str = timestamp.ToString() + deviceId + number.ToString();
        byte[] bytes = Encoding.UTF8.GetBytes(str);
        byte[] hash = sha256.ComputeHash(bytes);
        return BitConverter.ToString(hash).Replace("-", "").ToLower();
    }
    catch (Exception ex)
    {
        Console.WriteLine($"GetAntiReplaySignature failed: {ex.Message}");
        return string.Empty;
    }
}

```

请求成功后获得返回：

```json
{
    "vid":,
    "skey":"",
    "accessToken":"",
    "refreshToken":"",
    "openId":"",
    "wxAccessToken":"",
    "user":
    {
        "name":"",
        "avatar":""
    },
    "firstLogin":0,
    "userAgreement":1
    }
```

通过`vid`和`skey`可以获取微信读书的资源，通过 `refreshToken` 可以刷新 `skey`。

## 5. 刷新登录凭证

当请求资源返回为401错误时,需要刷新登录凭证：

```json
{
    "errcode": -2012,
    "errlog": "",
    "errmsg": "登录超时"
}
```

请求方法为：

```bash
curl -H "baseapi: 34"\
     -H "appver: 1.9.3.10244349"\
     -H "osver: 14"\
     -H "channelid: 990"\
     -H "basever: 1.9.3.10244349"\
     -H "user-agent: WeRead/1.9.3 WRBrand/null wr_eink Dalvik/2.1.0 (Linux; U; Android 14; Redmi Note 7 Build/AP2A.240905.003)" \
     -H "content-type: application/json; charset=UTF-8" --data-binary "{\"deviceId\":\"\",\"deviceName\":\"Redmi Note 7\",\"inBackground\":0,\"kickType\":1,\"random\":91,\"refCgi\":\"\",\"refreshToken\":\"\",\"signature\":\"\",\"timestamp\":1742816294625,\"trackId\":\"\",\"wxToken\":0}" \
     "https://i.weread.qq.com/login"
```

请求体：

```json
{
    "deviceId": "",
    "deviceName": "Redmi Note 7",
    "inBackground": 0,
    "kickType": 1,
    "random": 91,
    "refCgi": "",
    "refreshToken": "",
    "signature": "",
    "timestamp": 1742816294625,
    "trackId": "",
    "wxToken": 0
}
```
